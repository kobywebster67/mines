<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Make Money Co ‚Äî Account Fixed</title>

  <link href="https://fonts.googleapis.com/css2?family=Bungee&family=Poppins:wght@300;500;700&display=swap" rel="stylesheet" />

  <style>
    :root {
      --bg: #0f1720;
      --panel: rgba(255,255,255,0.04);
      --accent: #ffd43b;
      --text-light: #cfe6ff;
      --text-muted: #8fa9cb;
      --btn-bg: #22272b;
      --btn-hover: #444b52;
      --green-1: #28a745;
      --green-2: #218838;
      --font-primary: 'Poppins', system-ui, Segoe UI, Roboto, Arial, sans-serif;
      --font-display: 'Bungee', cursive;
    }
    * { box-sizing: border-box; }
    html,body { height:100%; }
    body {
      margin: 0;
      min-height: 100vh;
      background:
        radial-gradient(1200px 500px at 10% 10%, rgba(255,215,0,0.03), transparent 10%),
        radial-gradient(800px 400px at 90% 80%, rgba(0,200,255,0.02), transparent 10%),
        linear-gradient(180deg, var(--bg), #050608);
      font-family: var(--font-primary);
      color: var(--text-light);
      display: flex;
      justify-content: center;
      padding: 20px;
    }
    .container {
      width: 420px;
      max-width: 96vw;
      background: var(--panel);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.7);
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    h1 {
      font-family: var(--font-display);
      font-size: 2rem;
      margin: 0;
      color: var(--accent);
      text-shadow: 0 6px 20px rgba(0,0,0,0.6);
    }
    .balance {
      text-align: right;
      font-size: 1.1rem;
      user-select: none;
    }
    .balance span { font-weight:700; font-size:1.5rem; display:block; margin-top:4px; }

    /* Tabs */
    nav.tabs { display:flex; gap:6px; border-bottom:1.5px solid rgba(255,255,255,0.1); }
    nav.tabs button {
      flex:1; background:var(--btn-bg); border:none; padding:10px 0;
      font-weight:600; color:var(--text-muted); cursor:pointer; font-size:0.9rem;
      border-radius:8px 8px 0 0; transition: background-color 0.3s, color 0.3s; user-select:none;
    }
    nav.tabs button.active { background:var(--accent); color:#081219; box-shadow:0 6px 20px rgba(0,0,0,0.4); border-bottom:none; }

    /* Sections */
    section { display:none; flex-direction:column; gap:12px; }
    section.active { display:flex; }

    /* Clicker */
    #clicker-section { text-align:center; }
    #money-bag {
      margin: 20px auto 16px; width:140px; height:140px; background:linear-gradient(145deg,#3a3a3a,#252525);
      border-radius:50%; box-shadow: inset 0 6px 15px #ffcf52, 0 4px 15px rgba(255,208,0,0.5);
      display:flex; align-items:center; justify-content:center; font-size:70px; color:#ffcf52; cursor:pointer;
      position:relative; user-select:none;
    }
    #money-bag:hover { box-shadow: inset 0 6px 18px #ffd64d, 0 6px 24px rgba(255,215,0,0.8); transform:scale(1.05); transition:0.15s ease; }

    #coins-info { font-size:1.1rem; font-weight:600; margin-bottom:6px; }
    #cpc-info { color:var(--text-muted); font-size:0.9rem; margin-bottom:16px; }

    #upgrades { display:flex; flex-direction:column; gap:8px; max-height:260px; overflow-y:auto; padding-right:6px; }
    .upgrade { background:var(--btn-bg); border-radius:10px; padding:10px 14px; cursor:pointer; transition:background-color 0.3s; display:flex; justify-content:space-between; align-items:center; user-select:none; }
    .upgrade:hover:not(.disabled) { background:var(--btn-hover); }
    .upgrade.disabled { opacity:0.5; cursor:not-allowed; }
    .upgrade-name { font-weight:700; font-size:0.95rem; }
    .upgrade-info { font-size:0.8rem; color:var(--text-muted); margin-left:8px; flex-grow:1; text-align:center; }
    .upgrade-cost { font-weight:700; min-width:70px; text-align:right; font-size:0.9rem; color:var(--accent); }

    #rebirth-btn { margin-top:14px; padding:10px 18px; font-weight:700; font-size:1rem; background:linear-gradient(180deg,var(--green-1),var(--green-2)); border:none; border-radius:10px; color:white; cursor:pointer; user-select:none; transition:filter 0.2s; }
    #rebirth-btn:disabled { filter:grayscale(70%); cursor:not-allowed; opacity:0.6; }

    /* Gambling */
    #gambling-section { display:flex; flex-direction:column; gap:12px; }
    .gambling-tabs { display:flex; gap:10px; justify-content:center; margin-bottom:12px; }
    .gambling-tabs button { flex:1; background:var(--btn-bg); border:none; padding:8px 0; font-weight:600; color:var(--text-muted); cursor:pointer; font-size:0.9rem; border-radius:10px; user-select:none; transition:background-color 0.3s, color 0.3s; }
    .gambling-tabs button.active { background:var(--accent); color:#081219; box-shadow:0 6px 20px rgba(0,0,0,0.4); }

    /* Slot */
    #slot-machine-container { display:flex; flex-direction:column; gap:10px; text-align:center; }
    #slot-reels { font-size:50px; letter-spacing:18px; margin:10px 0; user-select:none; }
    #slot-reward { font-weight:700; font-size:1.1rem; min-height:30px; color:var(--accent); user-select:none; }
    #slot-bet { width:100%; padding:10px; border-radius:8px; border:none; background:var(--btn-bg); color:var(--text-light); font-size:1rem; margin-bottom:10px; text-align:center; user-select:none; }
    #slot-spin-btn { padding:12px; font-weight:700; background:linear-gradient(180deg,var(--green-1),var(--green-2)); border:none; border-radius:10px; color:white; cursor:pointer; user-select:none; transition:filter 0.2s; }
    #slot-spin-btn:disabled { filter:grayscale(70%); cursor:not-allowed; opacity:0.6; }

    /* Mines */
    #mines-container { display:flex; flex-direction:column; gap:10px; user-select:none; }
    #mines-controls { display:flex; gap:8px; justify-content:space-between; align-items:center; margin-bottom:10px; }
    #mines-bet { flex:1; padding:8px; border-radius:8px; border:none; background:var(--btn-bg); color:var(--text-light); font-size:1rem; text-align:center; }
    #mines-mode { flex:1; padding:8px; border-radius:8px; border:none; background:var(--btn-bg); color:var(--text-light); font-size:1rem; user-select:none; }
    #mines-start-btn, #mines-cashout-btn { flex:1; padding:10px; border-radius:10px; border:none; font-weight:700; font-size:1rem; color:white; cursor:pointer; user-select:none; transition:filter 0.2s; }
    #mines-start-btn { background:linear-gradient(180deg,var(--green-1),var(--green-2)); }
    #mines-cashout-btn { background:#555; }
    #mines-start-btn:disabled, #mines-cashout-btn:disabled { filter:grayscale(70%); cursor:not-allowed; opacity:0.6; }

    #mines-grid { display:grid; grid-template-columns:repeat(5,50px); grid-gap:8px; justify-content:center; }
    .mines-cell { width:50px; height:50px; background:var(--btn-bg); border-radius:8px; font-size:28px; color:var(--text-light); cursor:pointer; display:flex; align-items:center; justify-content:center; user-select:none; transition:background-color 0.3s; border:2px solid transparent; font-weight:700; }
    .mines-cell:hover:not(.revealed) { background:var(--btn-hover); }
    .mines-cell.revealed.gem { background:#ffd43b; color:#3a2e00; cursor:default; }
    .mines-cell.revealed.bomb { background:#ff5050; color:#400000; cursor:default; }

    #mines-stats { font-size:0.9rem; text-align:center; color:var(--text-muted); user-select:none; margin-top:6px; }
    #mines-stats span { font-weight:600; color:var(--accent); }

    /* Account Section - replaced with tabbed login/register UI */
    #account-section { color:var(--text-muted); gap:8px; display:flex; flex-direction:column; }
    .account-panel { background:rgba(255,255,255,0.02); border-radius:10px; padding:10px; display:flex; flex-direction:column; gap:8px; }
    .account-row { display:flex; gap:8px; align-items:center; }
    .account-input { flex:1; padding:8px; border-radius:8px; border:none; background:var(--btn-bg); color:var(--text-light); }
    .account-btn { padding:8px 10px; border-radius:8px; border:none; background:var(--accent); color:#081219; font-weight:700; cursor:pointer; }
    .account-small { font-size:0.85rem; color:var(--text-muted); }

    /* internal account tabs */
    .acct-tabs { display:flex; gap:8px; margin-bottom:6px; }
    .acct-tab { flex:1; background:var(--btn-bg); border:none; padding:8px; color:var(--text-muted); border-radius:8px; cursor:pointer; font-weight:700; }
    .acct-tab.active { background:var(--accent); color:#081219; }

    .acct-form { display:flex; flex-direction:column; gap:8px; }
    .acct-form.hidden { display:none; }

    /* Toast */
    #toast { position:fixed; top:20px; right:20px; background:rgba(0,0,0,0.75); color:white; padding:10px 14px; border-radius:10px; font-weight:700; opacity:0; pointer-events:none; transform:translateY(-20px); transition:opacity 0.3s, transform 0.3s; z-index:9999; user-select:none; }
    #toast.show { opacity:1; pointer-events:auto; transform:translateY(0); }

    /* Scrollbar for upgrades */
    #upgrades::-webkit-scrollbar { width:8px; }
    #upgrades::-webkit-scrollbar-track { background:transparent; }
    #upgrades::-webkit-scrollbar-thumb { background:var(--accent); border-radius:4px; }

    /* Fine print */
    #footer { text-align:right; font-size:10px; color:var(--text-muted); user-select:none; margin-top:6px; font-style:italic; }

    @media (max-width:480px) {
      .container { width: 96vw; padding:14px; }
      #money-bag { width:120px; height:120px; font-size:60px; }
      #slot-reels { font-size:40px; letter-spacing:14px; }
    }
  </style>
</head>
<body>
  <div class="container" role="main" aria-label="Make Money Co game">

    <header>
      <h1>Make Money Co</h1>
      <div class="balance" aria-live="polite" aria-atomic="true">
        Bank: $<span id="balance">0.00</span>
      </div>
    </header>

    <nav class="tabs" role="tablist" aria-label="Game sections">
      <button role="tab" aria-selected="true" aria-controls="clicker-section" id="tab-clicker" class="active">Clicker</button>
      <button role="tab" aria-selected="false" aria-controls="gambling-section" id="tab-gambling">Gambling</button>
      <button role="tab" aria-selected="false" aria-controls="info-section" id="tab-info">Info</button>
      <button role="tab" aria-selected="false" aria-controls="account-section" id="tab-account">Account</button>
    </nav>

    <!-- CLICKER SECTION -->
    <section id="clicker-section" class="active" role="tabpanel" aria-labelledby="tab-clicker">
      <div id="money-bag" aria-label="Money bag, click to earn coins" tabindex="0" role="button" title="Click to earn coins">üí∞</div>
      <div id="coins-info" aria-live="polite" aria-atomic="true">Coins Earned: <span id="coins">0.00</span></div>
      <div id="cpc-info">Coins Per Click: <span id="cpc">1.00</span></div>
      <div id="upgrades" aria-label="Upgrades list"></div>
      <button id="rebirth-btn" disabled aria-disabled="true" title="Rebirth to double your coins per click">Rebirth (requires $100,000,000,000)</button>
    </section>

    <!-- GAMBLING SECTION -->
    <section id="gambling-section" role="tabpanel" aria-labelledby="tab-gambling" aria-hidden="true">
      <nav class="gambling-tabs" role="tablist" aria-label="Gambling games">
        <button id="slot-btn" class="active" role="tab" aria-selected="true" aria-controls="slot-machine-container" tabindex="0">Slot Machine</button>
        <button id="mines-btn" role="tab" aria-selected="false" aria-controls="mines-container" tabindex="-1">Mines Gem Game</button>
      </nav>

      <!-- Slot Machine -->
      <div id="slot-machine-container" role="tabpanel" aria-labelledby="slot-btn">
        <input id="slot-bet" type="number" min="50" step="1" value="50" aria-label="Slot machine bet amount" />
        <button id="slot-spin-btn" aria-live="polite" aria-atomic="true">Spin üé∞</button>
        <div id="slot-reels" aria-live="polite" aria-atomic="true" aria-label="Slot reels display">üçí üçã üçâ</div>
        <div id="slot-reward" aria-live="polite" aria-atomic="true" style="min-height: 30px;"></div>
      </div>

      <!-- Mines Gem Game -->
      <div id="mines-container" role="tabpanel" aria-labelledby="mines-btn" style="display:none;">
        <div id="mines-controls">
          <input id="mines-bet" type="number" min="1" step="1" value="10" aria-label="Mines game bet amount" />
          <select id="mines-mode" aria-label="Number of bombs">
            <option value="1">1 Bomb</option>
            <option value="2">2 Bombs</option>
            <option value="3">3 Bombs</option>
          </select>
          <button id="mines-start-btn">Start</button>
          <button id="mines-cashout-btn" disabled>Cash Out</button>
        </div>
        <div id="mines-grid" aria-label="Mines grid" role="grid" aria-readonly="true"></div>
        <div id="mines-stats" aria-live="polite" aria-atomic="true">
          Gems Found: <span id="mines-gems">0</span> &nbsp;|&nbsp; Multiplier: <span id="mines-multiplier">1.00x</span> &nbsp;|&nbsp; Potential Win: $<span id="mines-money">0.00</span>
        </div>
      </div>
    </section>

    <!-- INFO SECTION -->
    <section id="info-section" role="tabpanel" aria-labelledby="tab-info" aria-hidden="true" style="color: var(--text-muted); font-size: 0.9rem;">
      <p><strong>Make Money Co</strong> - Created by Koby Webster</p>
      <p>This game combines a coin clicker, slot machine, and mines gem game.</p>
      <p>Earn coins by clicking, gamble them, upgrade your clicks, and rebirth to progress faster.</p>
      <hr />
      <p><strong>Rebirth</strong> lets you reset progress in exchange for doubling your coins per click permanently.</p>
      <p>At 100 Billion coins, you can rebirth to double your coins per click permanently.</p>
      <p>Keep rebirthing to grow faster!</p>
    </section>

    <!-- ACCOUNT SECTION -->
    <section id="account-section" role="tabpanel" aria-labelledby="tab-account" aria-hidden="true" style="display:none;">
      <div class="account-panel" role="region" aria-label="Account panel">

        <div class="acct-tabs">
          <button id="acct-tab-login" class="acct-tab active" type="button">Login</button>
          <button id="acct-tab-register" class="acct-tab" type="button">Register</button>
        </div>

        <!-- LOGIN FORM -->
        <form id="acct-login-form" class="acct-form" onsubmit="return false;">
          <input id="login-username" class="account-input" placeholder="Username" aria-label="login username" autocomplete="username" />
          <input id="login-password" type="password" class="account-input" placeholder="Password" aria-label="login password" autocomplete="current-password" />
          <div class="account-row">
            <button id="acct-login-btn" class="account-btn" type="button">Login</button>
          </div>
        </form>

        <!-- REGISTER FORM -->
        <form id="acct-register-form" class="acct-form hidden" onsubmit="return false;">
          <input id="reg-username" class="account-input" placeholder="Choose a username" aria-label="register username" autocomplete="username" />
          <input id="reg-password" type="password" class="account-input" placeholder="Choose a password" aria-label="register password" autocomplete="new-password" />
          <input id="reg-password-confirm" type="password" class="account-input" placeholder="Confirm password" aria-label="confirm password" autocomplete="new-password" />
          <div class="account-row">
            <button id="acct-register-btn" class="account-btn" type="button">Create Account</button>
          </div>
        </form>

        <div class="account-row">
          <button id="acct-manual-save" class="account-btn" style="flex:1;">Manual Save</button>
        </div>

        <div class="account-row account-small" id="acct-status">Not logged in</div>
        <div class="account-row account-small">Auto-save: every 60s (saved to localStorage)</div>
      </div>
    </section>

    <div id="toast" role="alert" aria-live="assertive" aria-atomic="true"></div>
    <div id="footer">Made By Koby Webster</div>
  </div>

  <script>
    // ===========================
    // Full game code (unchanged logic) + improved account UI handlers
    // ===========================

    // === Shared bank and utility ===
    let balance = 0;
    const balanceEl = document.getElementById('balance');
    function updateBalance(amountChange=0) {
      balance += amountChange;
      if(balance < 0) balance = 0;
      balanceEl.textContent = balance.toFixed(2);
      updateUpgradeButtons();
      updateRebirthButton();
      updateSlotBet();
      updateMinesBet();
    }

    // === TOAST ===
    const toast = document.getElementById('toast');
    let toastTimeout;
    function showToast(msg, duration=2000) {
      clearTimeout(toastTimeout);
      toast.textContent = msg;
      toast.classList.add('show');
      toastTimeout = setTimeout(() => toast.classList.remove('show'), duration);
    }

    // === TABS ===
    const tabs = document.querySelectorAll('nav.tabs button');
    const sections = document.querySelectorAll('section[role="tabpanel"]');
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        tabs.forEach(t => {
          t.classList.remove('active');
          t.setAttribute('aria-selected', 'false');
          const ctrl = t.getAttribute('aria-controls');
          if(ctrl) {
            const el = document.getElementById(ctrl);
            if(el) {
              el.setAttribute('aria-hidden', 'true');
              el.classList.remove('active');
              el.style.display = 'none';
            }
          }
        });
        tab.classList.add('active');
        tab.setAttribute('aria-selected', 'true');
        const target = tab.getAttribute('aria-controls');
        if(target) {
          const sec = document.getElementById(target);
          if(sec) {
            sec.setAttribute('aria-hidden', 'false');
            sec.classList.add('active');
            sec.style.display = '';
          }
        }
      });
    });

    // === CLICKER SECTION ===
    let coins = 0;
    let coinsPerClick = 0.05;
    const coinsEl = document.getElementById('coins');
    const cpcEl = document.getElementById('cpc');
    const moneyBag = document.getElementById('money-bag');
    const upgradesContainer = document.getElementById('upgrades');
    const rebirthBtn = document.getElementById('rebirth-btn');

    // Upgrades data
    const upgradesData = [
      { name: 'Small Tip', baseCost: 1500, cost: 1500, cpcIncrease: 1, level: 0 },
      { name: 'Wallet Upgrade', baseCost: 50000, cost: 50000, cpcIncrease: 2, level: 0 },
      { name: 'Coin Press', baseCost: 100000, cost: 100000, cpcIncrease: 3, level: 0 },
      { name: 'Gold Miner', baseCost: 150000, cost: 150000, cpcIncrease: 4, level: 0 },
      { name: 'Bank Vault', baseCost: 250000, cost: 250000, cpcIncrease: 5, level: 0 },
      { name: 'Fortune Wheel', baseCost: 500000, cost: 500000, cpcIncrease: 10, level: 0 },
      { name: 'Money Factory', baseCost: 1000000, cost: 1000000, cpcIncrease: 15, level: 0 },
      { name: 'Bitcoin Miner', baseCost: 8000000, cost: 8000000, cpcIncrease: 20, level: 0 },
      { name: 'Diamond Mine', baseCost: 50000000, cost: 50000000, cpcIncrease: 100, level: 0 },
      { name: 'Rebirth Lab', baseCost: 100000000000, cost: 100000000000, cpcIncrease: 0, level: 0, special:true }
    ];

    // Build upgrade buttons
    function buildUpgrades() {
      upgradesContainer.innerHTML = '';
      upgradesData.forEach((upg, i) => {
        const div = document.createElement('div');
        div.className = 'upgrade';
        div.dataset.idx = i;
        div.setAttribute('tabindex', '0');
        if(upg.cost > balance) div.classList.add('disabled');

        div.innerHTML = `
          <div class="upgrade-name">${upg.name}${upg.special ? ' (Rebirth)' : ''}</div>
          <div class="upgrade-info">${upg.level > 0 ? 'Level ' + upg.level : ''}</div>
          <div class="upgrade-cost">$${upg.cost.toLocaleString()}</div>
        `;

        div.addEventListener('click', () => buyUpgrade(i));
        div.addEventListener('keydown', e => {
          if(e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            buyUpgrade(i);
          }
        });

        upgradesContainer.appendChild(div);
      });
    }

    function updateUpgradeButtons() {
      const upgradeDivs = upgradesContainer.querySelectorAll('.upgrade');
      upgradeDivs.forEach(div => {
        const i = +div.dataset.idx;
        const upg = upgradesData[i];
        if(upg.cost > balance) div.classList.add('disabled');
        else div.classList.remove('disabled');

        // Update level & cost text:
        div.querySelector('.upgrade-info').textContent = upg.level > 0 ? 'Level ' + upg.level : '';
        div.querySelector('.upgrade-cost').textContent = `$${upg.cost.toLocaleString()}`;
      });
    }

    function buyUpgrade(i) {
      const upg = upgradesData[i];
      if(balance < upg.cost) {
        showToast("Not enough balance for " + upg.name);
        return;
      }
      if(upg.special) {
        // Rebirth lab can only be bought once, handled separately
        showToast("Buy the Rebirth button below to rebirth!");
        return;
      }
      balance -= upg.cost;
      updateBalance(0);
      coinsPerClick += upg.cpcIncrease;
      upg.level++;
      upg.cost = Math.floor(upg.baseCost * Math.pow(1.7, upg.level));
      showToast(`${upg.name} upgraded to level ${upg.level}`);
      updateCPC();
      buildUpgrades();
    }

    function updateCPC() {
      cpcEl.textContent = coinsPerClick.toFixed(2);
    }

    moneyBag.addEventListener('click', () => {
      // Add coinsPerClick directly to balance now
      updateBalance(coinsPerClick);
      coins += coinsPerClick; // keep total coins for display
      coinsEl.textContent = coins.toFixed(2);
    });
    moneyBag.addEventListener('keydown', e => {
      if(e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        moneyBag.click();
      }
    });

    // Rebirth logic
    rebirthBtn.addEventListener('click', () => {
      if(balance < 1_000_000_000) {
        showToast("Need 1,000,000,000 coins to rebirth");
        return;
      }
      balance = 0;
      coins = 0;
      coinsPerClick *= 2;
      upgradesData.forEach(upg => {
        upg.level = 0;
        upg.cost = upg.baseCost;
      });
      updateBalance(0);
      coinsEl.textContent = coins.toFixed(2);
      updateCPC();
      buildUpgrades();
      showToast("Rebirth successful! CPC doubled.");
      updateRebirthButton();
    });

    function updateRebirthButton() {
      if(balance >= 1_000_000_000) {
        rebirthBtn.disabled = false;
        rebirthBtn.setAttribute('aria-disabled', 'false');
      } else {
        rebirthBtn.disabled = true;
        rebirthBtn.setAttribute('aria-disabled', 'true');
      }
    }

    // === SLOT MACHINE ===
    const slotBetInput = document.getElementById('slot-bet');
    const slotSpinBtn = document.getElementById('slot-spin-btn');
    const slotReels = document.getElementById('slot-reels');
    const slotReward = document.getElementById('slot-reward');

    const slotSymbols = ['üçí', 'üçã', 'üçâ', '‚≠ê', 'üíé', '7Ô∏è‚É£'];
    const slotSymbolWeights = [30, 25, 20, 15, 8, 2]; // relative freq weights

    function weightedRandomSymbol() {
      const totalWeight = slotSymbolWeights.reduce((a,b) => a+b, 0);
      let rand = Math.random() * totalWeight;
      for(let i=0; i<slotSymbols.length; i++) {
        if(rand < slotSymbolWeights[i]) return slotSymbols[i];
        rand -= slotSymbolWeights[i];
      }
      return slotSymbols[0];
    }

    function updateSlotBet() {
      let val = Number(slotBetInput.value);
      if(isNaN(val) || val < 50) val = 50;
      if(val > balance) val = balance;
      slotBetInput.value = val;
      slotSpinBtn.disabled = val > balance;
    }
    slotBetInput.addEventListener('input', updateSlotBet);

    slotSpinBtn.addEventListener('click', () => {
      let bet = Number(slotBetInput.value);
      if(bet > balance) {
        showToast("Not enough balance");
        return;
      }
      balance -= bet;
      updateBalance(0);
      slotSpinBtn.disabled = true;
      slotReward.textContent = '';
      slotReels.textContent = '‚ùì ‚ùì ‚ùì';

      // Animate reels cycling for 1.5s
      let iterations = 30;
      let i = 0;
      const spinInterval = setInterval(() => {
        slotReels.textContent =
          `${weightedRandomSymbol()} ${weightedRandomSymbol()} ${weightedRandomSymbol()}`;
        i++;
        if(i >= iterations) {
          clearInterval(spinInterval);
          const results = slotReels.textContent.split(' ');
          const payout = calculateSlotPayout(results, bet);
          if(payout > 0) {
            balance += payout;
            updateBalance(0);
            slotReward.textContent = `You won $${payout.toFixed(2)}! üéâ`;
          } else {
            slotReward.textContent = "No win, try again!";
          }
          slotSpinBtn.disabled = false;
        }
      }, 50);
    });

    // Slot payout rules
    function calculateSlotPayout(results, bet) {
      const [a,b,c] = results;
      if(a === b && b === c) {
        switch(a) {
          case '7Ô∏è‚É£': return bet * 100;
          case 'üíé': return bet * 50;
          case '‚≠ê': return bet * 25;
          case 'üçâ': return bet * 10;
          case 'üçã': return bet * 5;
          case 'üçí': return bet * 3;
        }
      }
      if(a === b || b === c || a === c) return bet * 0.5;
      return 0;
    }

    // === MINES GEM GAME ===
    const minesBetInput = document.getElementById('mines-bet');
    const minesModeSelect = document.getElementById('mines-mode');
    const minesStartBtn = document.getElementById('mines-start-btn');
    const minesCashoutBtn = document.getElementById('mines-cashout-btn');
    const minesGrid = document.getElementById('mines-grid');
    const minesGemsEl = document.getElementById('mines-gems');
    const minesMultEl = document.getElementById('mines-multiplier');
    const minesMoneyEl = document.getElementById('mines-money');

    const MINES_SIZE = 25;
    let minesCells = [];
    let bombPositions = new Set();
    let gemsFound = 0;
    let minesBet = 10;
    let minesGameOver = true;
    let minesMultipliers = [];

    const minesMultipliersMap = {
      1: [1.1,1.2,1.3,1.5,1.7,1.9,2.1,2.3,2.6,3,3.3,3.7,4.2,4.8,5.5,6.3,7.2,8.2,9.3,10.5],
      2: [1.3,1.5,1.7,1.9,2.2,2.5,3,3.5,4,4.5,5,5.7,6.5,7.5,8.5,9.7,11,12.5,14,16],
      3: [1.5,2,2.3,2.8,3.5,4.5,7,10,12,14,16,18,20,23,26,29,33,37,42,48]
    };

    function resetMinesGrid() {
      minesGrid.innerHTML = '';
      minesCells = [];
      for(let i=0; i<MINES_SIZE; i++) {
        const cell = document.createElement('div');
        cell.className = 'mines-cell';
        cell.dataset.idx = i;
        cell.setAttribute('role', 'button');
        cell.setAttribute('tabindex', '0');
        cell.addEventListener('click', () => revealMinesCell(i));
        cell.addEventListener('keydown', e => {
          if(e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            revealMinesCell(i);
          }
        });
        minesGrid.appendChild(cell);
        minesCells.push(cell);
      }
    }

    function startMinesGame() {
      let bet = Number(minesBetInput.value);
      if(isNaN(bet) || bet < 1) {
        showToast('Enter a valid bet (min 1)');
        return;
      }
      if(bet > balance) {
        showToast('Not enough balance');
        return;
      }
      minesBet = bet;
      balance -= bet;
      updateBalance(0);

      gemsFound = 0;
      minesGameOver = false;
      minesCashoutBtn.disabled = true;
      minesMultipliers = minesMultipliersMap[ Number(minesModeSelect.value) ] || minesMultipliersMap[1];

      // Place bombs
      bombPositions.clear();
      const bombsCount = Number(minesModeSelect.value);
      while(bombPositions.size < bombsCount) {
        bombPositions.add(Math.floor(Math.random() * MINES_SIZE));
      }

      resetMinesGrid();
      updateMinesStats();
      showToast('Mines game started!');

      minesStartBtn.disabled = true;
    }

    function revealMinesCell(idx) {
      if(minesGameOver) return;
      const cell = minesCells[idx];
      if(!cell || cell.classList.contains('revealed')) return;

      cell.classList.add('revealed');
      if(bombPositions.has(idx)) {
        cell.classList.add('bomb');
        cell.textContent = 'üí£';

        // reveal all bombs
        bombPositions.forEach(b => {
          if(b === idx) return;
          const c = minesCells[b];
          if(c && !c.classList.contains('revealed')) {
            c.classList.add('revealed', 'bomb');
            c.textContent = 'üí£';
          }
        });

        minesGameOver = true;
        minesCashoutBtn.disabled = true;
        minesStartBtn.disabled = false;
        showToast('Boom! You hit a bomb ‚Äî bet lost üí•', 3000);
      } else {
        cell.classList.add('gem');
        cell.textContent = 'üíé';
        gemsFound++;
        updateMinesStats();
        minesCashoutBtn.disabled = false;
      }
    }

    function updateMinesStats() {
      minesGemsEl.textContent = gemsFound;
      const idx = Math.min(gemsFound - 1, minesMultipliers.length -1);
      const mult = gemsFound > 0 ? minesMultipliers[idx] : 1;
      minesMultEl.textContent = mult.toFixed(2) + 'x';
      minesMoneyEl.textContent = (minesBet * mult).toFixed(2);
    }

    function cashOutMines() {
      if(minesGameOver) return;
      if(gemsFound === 0) {
        showToast('No gems found to cash out');
        return;
      }
      const idx = Math.min(gemsFound - 1, minesMultipliers.length -1);
      const mult = minesMultipliers[idx];
      const winnings = minesBet * mult;
      balance += winnings;
      updateBalance(0);
      showToast(`Cashed out $${winnings.toFixed(2)} ‚Äî nice!`, 3000);
      minesGameOver = true;
      minesCashoutBtn.disabled = true;
      minesStartBtn.disabled = false;
    }

    function updateMinesBet() {
      let val = Number(minesBetInput.value);
      if(isNaN(val) || val < 1) val = 1;
      if(val > balance) val = balance;
      minesBetInput.value = val;
      minesStartBtn.disabled = val > balance || !minesGameOver;
    }

    minesBetInput.addEventListener('input', updateMinesBet);

    minesStartBtn.addEventListener('click', startMinesGame);
    minesCashoutBtn.addEventListener('click', cashOutMines);

    // Switch between slot and mines tabs inside gambling section
    const slotBtn = document.getElementById('slot-btn');
    const minesBtn = document.getElementById('mines-btn');
    const slotContainer = document.getElementById('slot-machine-container');
    const minesContainer = document.getElementById('mines-container');

    slotBtn.addEventListener('click', () => {
      slotBtn.classList.add('active');
      slotBtn.setAttribute('aria-selected', 'true');
      slotBtn.setAttribute('tabindex', '0');
      minesBtn.classList.remove('active');
      minesBtn.setAttribute('aria-selected', 'false');
      minesBtn.setAttribute('tabindex', '-1');
      slotContainer.style.display = 'flex';
      minesContainer.style.display = 'none';
    });
    minesBtn.addEventListener('click', () => {
      minesBtn.classList.add('active');
      minesBtn.setAttribute('aria-selected', 'true');
      minesBtn.setAttribute('tabindex', '0');
      slotBtn.classList.remove('active');
      slotBtn.setAttribute('aria-selected', 'false');
      slotBtn.setAttribute('tabindex', '-1');
      slotContainer.style.display = 'none';
      minesContainer.style.display = 'flex';
    });

    // === Account & local save (fixed UI + handlers) ===

    // DOM references for account UI
    const acctTabLogin = document.getElementById('acct-tab-login');
    const acctTabRegister = document.getElementById('acct-tab-register');
    const acctLoginForm = document.getElementById('acct-login-form');
    const acctRegisterForm = document.getElementById('acct-register-form');

    const loginUsername = document.getElementById('login-username');
    const loginPassword = document.getElementById('login-password');
    const loginBtn = document.getElementById('acct-login-btn');

    const regUsername = document.getElementById('reg-username');
    const regPassword = document.getElementById('reg-password');
    const regPasswordConfirm = document.getElementById('reg-password-confirm');
    const regBtn = document.getElementById('acct-register-btn');

    const manualSaveBtn = document.getElementById('acct-manual-save');
    const acctStatusEl = document.getElementById('acct-status');

    // current logged in user (lowercase) or null
    let currentAccount = null;

    // tab switching inside account panel
    acctTabLogin.addEventListener('click', () => {
      acctTabLogin.classList.add('active');
      acctTabRegister.classList.remove('active');
      acctLoginForm.classList.remove('hidden');
      acctRegisterForm.classList.add('hidden');
    });
    acctTabRegister.addEventListener('click', () => {
      acctTabRegister.classList.add('active');
      acctTabLogin.classList.remove('active');
      acctRegisterForm.classList.remove('hidden');
      acctLoginForm.classList.add('hidden');
    });

    // password hashing utilities (Web Crypto if available)
    function generateSalt(len = 16) {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
      let s = '';
      for(let i=0;i<len;i++) s += chars[Math.floor(Math.random()*chars.length)];
      return s;
    }
    function bufToHex(buffer) {
      const b = new Uint8Array(buffer);
      let s = '';
      for(let i=0;i<b.length;i++) s += b[i].toString(16).padStart(2,'0');
      return s;
    }
    async function hashPassword(password, salt) {
      const input = password + '||' + salt;
      if(window.crypto && crypto.subtle && crypto.subtle.digest) {
        const enc = new TextEncoder();
        const data = enc.encode(input);
        const digest = await crypto.subtle.digest('SHA-256', data);
        return bufToHex(digest);
      } else {
        return btoa(input);
      }
    }

    // local users stored as JSON under 'mmc_local_users'
    function readUsers() {
      try {
        const raw = localStorage.getItem('mmc_local_users');
        return raw ? JSON.parse(raw) : {};
      } catch (e) { return {}; }
    }
    function writeUsers(users) {
      localStorage.setItem('mmc_local_users', JSON.stringify(users));
    }

    // Register handler
    regBtn.addEventListener('click', async () => {
      const u = String(regUsername.value || '').trim();
      const p = String(regPassword.value || '');
      const pc = String(regPasswordConfirm.value || '');
      if(!u || !p || !pc) { showToast('Fill all fields'); return; }
      if(u.length < 2) { showToast('Username too short'); return; }
      if(p.length < 4) { showToast('Password too short (min 4)'); return; }
      if(p !== pc) { showToast('Passwords do not match'); return; }

      try {
        const users = readUsers();
        const uname = u.toLowerCase();
        if(users[uname]) { showToast('Username already exists'); return; }
        const salt = generateSalt(16);
        const hash = await hashPassword(p, salt);
        users[uname] = { salt, hash, createdAt: Date.now() };
        writeUsers(users);
        currentAccount = uname;
        acctStatusEl.textContent = `Logged in as ${currentAccount}`;
        // try to load existing save (if any)
        if(loadLocal()) showToast('Account created ‚Äî save loaded');
        else showToast('Account created');
        // clear register fields for privacy
        regPassword.value = regPasswordConfirm.value = '';
      } catch (err) {
        console.error(err);
        showToast('Register error: ' + (err.message || err));
      }
    });

    // Login handler
    loginBtn.addEventListener('click', async () => {
      const u = String(loginUsername.value || '').trim();
      const p = String(loginPassword.value || '');
      if(!u || !p) { showToast('Fill username and password'); return; }
      try {
        const users = readUsers();
        const uname = u.toLowerCase();
        const rec = users[uname];
        if(!rec) { showToast('Invalid username or password'); return; }
        const candidate = await hashPassword(p, rec.salt);
        if(candidate !== rec.hash) { showToast('Invalid username or password'); return; }
        currentAccount = uname;
        acctStatusEl.textContent = `Logged in as ${currentAccount}`;
        if(loadLocal()) showToast('Logged in ‚Äî save loaded');
        else showToast('Logged in (no save found)');
        // clear login fields for privacy
        loginPassword.value = '';
      } catch (err) {
        console.error(err);
        showToast('Login error: ' + (err.message || err));
      }
    });

    // Save/load helpers (localStorage)
    function buildSavePayload() {
      return {
        balance,
        coins,
        coinsPerClick,
        upgrades: upgradesData.map(u => ({ name: u.name, level: u.level, cost: u.cost })),
        mines: { gemsFound, minesBet, minesGameOver },
        timestamp: Date.now()
      };
    }
    async function saveLocal(userInitiated=false) {
      try {
        const payload = buildSavePayload();
        const key = currentAccount ? `mmc_save_${currentAccount}` : 'mmc_save_guest';
        localStorage.setItem(key, JSON.stringify({ savedAt: Date.now(), save: payload }));
        if(userInitiated) showToast(currentAccount ? 'Saved (local)' : 'Saved (guest)');
        return true;
      } catch (err) {
        console.error('saveLocal', err);
        if(userInitiated) showToast('Save failed: ' + err.message);
        return false;
      }
    }
    function loadLocal() {
      try {
        const key = currentAccount ? `mmc_save_${currentAccount}` : 'mmc_save_guest';
        const raw = localStorage.getItem(key);
        if(!raw) return false;
        const parsed = JSON.parse(raw);
        if(parsed && parsed.save) {
          applySavePayload(parsed.save);
          return true;
        }
        return false;
      } catch (err) {
        console.error('loadLocal', err);
        return false;
      }
    }
    function applySavePayload(payload) {
      try {
        if(typeof payload.balance === 'number') balance = payload.balance;
        if(typeof payload.coins === 'number') coins = payload.coins;
        if(typeof payload.coinsPerClick === 'number') coinsPerClick = payload.coinsPerClick;
        if(Array.isArray(payload.upgrades)) {
          payload.upgrades.forEach(sv => {
            const upg = upgradesData.find(u => u.name === sv.name);
            if(upg) {
              upg.level = sv.level || 0;
              upg.cost = sv.cost || upg.baseCost;
            }
          });
        }
        if(payload.mines) {
          gemsFound = payload.mines.gemsFound || 0;
          minesBet = payload.mines.minesBet || minesBet;
          minesGameOver = payload.mines.minesGameOver !== undefined ? payload.mines.minesGameOver : minesGameOver;
        }
        updateBalance(0);
        coinsEl.textContent = coins.toFixed(2);
        updateCPC();
        buildUpgrades();
        resetMinesGrid();
      } catch (err) {
        console.error('applySavePayload error', err);
      }
    }

    // Manual save button
    manualSaveBtn.addEventListener('click', async () => {
      await saveLocal(true);
    });

    // auto-save every 60s
    let autoSaveInterval = null;
    function startAutoSaveTimer() {
      if(autoSaveInterval) clearInterval(autoSaveInterval);
      autoSaveInterval = setInterval(() => {
        saveLocal(false);
      }, 60_000);
    }

    // load guest save on startup
    function tryLoadGuestSave() {
      const raw = localStorage.getItem('mmc_save_guest');
      if(raw) {
        try {
          const parsed = JSON.parse(raw);
          if(parsed && parsed.save) {
            applySavePayload(parsed.save);
            showToast('Loaded guest save', 1000);
          }
        } catch (e) { /* ignore parse errors */ }
      }
    }

    // Save on unload
    window.addEventListener('beforeunload', () => {
      try { saveLocal(false); } catch (e) {}
    });

    // initialize
    function init() {
      updateBalance(0);
      buildUpgrades();
      updateCPC();
      updateRebirthButton();
      updateSlotBet();
      updateMinesBet();
      resetMinesGrid();
      startAutoSaveTimer();
      tryLoadGuestSave();
    }
    init();

    // Expose manualSave to window if you need it
    window.manualSave = () => saveLocal(true);

    // End of script
  </script>
</body>
</html>
